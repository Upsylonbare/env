#!/bin/sh

# Colored manpages
export LESS_TERMCAP_mb=$'\e[1;32m'
export LESS_TERMCAP_md=$'\e[1;32m'
export LESS_TERMCAP_me=$'\e[0m'
export LESS_TERMCAP_se=$'\e[0m'
export LESS_TERMCAP_so=$'\e[01;33m'
export LESS_TERMCAP_ue=$'\e[0m'
export LESS_TERMCAP_us=$'\e[1;4;31m'

export EDITOR=vim
export FZF_DEFAULT_OPTS

# set PATH so it includes user's private bin if it exists
if [ -d "$HOME/bin" ] ; then
    PATH="$HOME/bin:$PATH"
fi

# set PATH so it includes user's private bin if it exists
if [ -d "$HOME/.local/bin" ] ; then
    PATH="$HOME/.local/bin:$PATH"
fi

# set PATH for cargo if it exists
if [ -d "$HOME/.carbo/bin" ] ; then
    PATH="$HOME/.cargo/bin:$PATH"
fi

# set PATH for texlive if it exists
if [ -d "/usr/local/texlive/2023/bin/x86_64-linux" ] ; then
    PATH="/usr/local/texlive/2023/bin/x86_64-linux:$PATH"
fi

# set PATH for texlive man if it exists
if [ -d "/usr/local/texlive/2023/texmf-dist/doc/man" ] ; then
    MANPATH="/usr/local/texlive/2023/texmf-dist/doc/man:$MANPATH"
fi

# set PATH for texlive info if it exists
if [ -d "/usr/local/texlive/2023/texmf-dist/doc/info" ] ; then
    INFOPATH="/usr/local/texlive/2023/texmf-dist/doc/info:$INFOPATH"
fi

# Test if current environnement is wsl2
if grep -qEi "(Microsoft|WSL)" /proc/version &> /dev/null ; then
    export DISPLAY=:0
fi

if [ -n "$DISPLAY" ]; then
  if xdpyinfo &> /dev/null; then
    echo "DISPLAY is set and valid."
  else
    echo "DISPLAY is set but invalid."
  fi
else
  echo "DISPLAY is not set."
fi

#My aliases
alias ll='exa -laF --group-directories-first --header --long'
alias la='exa -a --group-directories-first'
alias l='exa -lF --group-directories-first --header --long'

alias up='sudo apt-get update -y && sudo apt-get upgrade -y'
alias reload='echo "Sourcing environnement"; source ~/.zshrc'
alias cat='batcat -p'

alias findall="find * | \
                fzf --prompt 'All> ' \
                    --header 'CTRL-D: Directories / CTRL-F: Files' \
                    --bind 'ctrl-d:change-prompt(Directories>)+reload(find * -type d)' \
                    --bind 'ctrl-f:change-prompt(Files>)+reload(find * -type f)' |
                    xargs realpath | xclip -r -selection clipboard"

alias path="echo \$PATH | tr ':' '\n'"


_gitLogLineToHash="echo {} | grep -o '[a-f0-9]\{7\}' | head -1"

_view_commit="echo {} | $_gitLogLineToHash | xargs -I % sh -c 'git show --color=always % | diff-so-fancy' | less -R"
_view_file="echo {} | xargs -I % sh -c 'batcat --style=numbers --color=always % | less -R'"
_view_diff="echo {} | xargs -I % sh -c 'git diff % | diff-so-fancy' | less -R"
_copy_commit_hash="$_gitLogLineToHash | xclip -r -selection clipboard"
_git_checkout="$_gitLogLineToHash | xargs -I % sh -c 'git checkout %'"

k()
{
    ps -ef | fzf --reverse | awk '{print $2}' | xargs kill -9
}

gdiff() {
    local path_to_repo=$(git rev-parse --show-toplevel)
    git diff \
        $@ \
        --name-only | sed "s,^,$path_to_repo/," |
            fzf -m \
                --reverse \
                --tiebreak=index \
                --no-multi \
                --ansi \
                --preview="git diff {} | diff-so-fancy" \
                --header "Enter: view file, CTRL-d: view diff" \
                --bind "enter:execute:$_view_file" \
                --bind "ctrl-d:execute:$_view_diff"
}

fe() {
    local file
    file=$(fzf --preview 'batcat --style=numbers --color=always {}')
    if [ -n "$file" ]; then
        editor "$file"
    fi
}

fcd() {
    local dir
    dir=$(find -L . -type d 2> /dev/null | fzf +m)

    if [ -n "$dir" ]; then
        cd "$dir"
    fi
}

lg() {
    if [ $# -eq 0 ]; then
        my_git_log -10000
    else
        my_git_log "$@"
    fi
}

my_git_log() {
    local display_check="xdpyinfo &> /dev/null"
    
    # Check if DISPLAY is set and valid
    if [ -n "$DISPLAY" ] && eval "$display_check"; then
        git log \
        --graph \
        --all \
        --oneline \
        --color=always \
        --format="%C(cyan)%hv %C(blue)%ar %C(auto)%d %C(yellow)%s%+b %C(white)%ae" "$@" |
        fzf -i -e +s \
            --reverse \
            --tiebreak=index \
            --no-multi \
            --ansi \
            --preview="$_view_commit" \
            --header "enter: view, CTRL+c: copy commit hash, CTRL+x: checkout" \
            --bind "enter:execute:$_view_commit" \
            --bind "ctrl-c:execute:$_copy_commit_hash" \
            --bind "ctrl-x:execute:$_git_checkout"
    else
        git log \
        --graph \
        --all \
        --oneline \
        --color=always \
        --format="%C(cyan)%hv %C(blue)%ar %C(auto)%d %C(yellow)%s%+b %C(white)%ae" "$@" |
        fzf -i -e +s \
            --reverse \
            --tiebreak=index \
            --no-multi \
            --ansi \
            --preview="$_view_commit" \
            --header "enter: view, CTRL+x: checkout" \
            --bind "enter:execute:$_view_commit" \
            --bind "ctrl-x:execute:$_git_checkout"
    fi

    
}

# Function to speed up git log command (write commit graph in .git/objects/info/commit-graph)
speed_lg()
{
    git config --global core.commitGraph true
    git config --global gc.writeCommitGraph true
    git commit-graph write
}

